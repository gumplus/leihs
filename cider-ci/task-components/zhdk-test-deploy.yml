
git_options:
  submodules:
    include_match: ^.*$

traits:
  g2016: true

scripts:

  fetch-dump:
    body: |
      set -euxo
      cd deploy
      export ANSIBLE_HOST_KEY_CHECKING=False
      ansible-playbook fetch-latest-dump_play.yml \
        --ssh-common-args '-i ~/.ssh/zhdk_ci_executor_rsa' \
        -i ../zhdk-inventory/prod-hosts

  restore-dump:
    timeout: 1 Hours
    start_when:
      fetch passed:
        script_key: fetch-dump
        states: [passed]
    body: |
      set -eux
      cd deploy
      export ANSIBLE_HOST_KEY_CHECKING=False
      ansible-playbook db-restore_play.yml \
        --ssh-common-args '-i ~/.ssh/zhdk_ci_executor_rsa' \
        -i ../zhdk-inventory/${DEPLOY_TARGET_INVENTORY}

  deploy:
    timeout: 1 Hour
    start_when:
      data from prod was synced: {script_key: restore-dump, states: [passed]}
    body: |
      set -eux
      cd deploy
      export ANSIBLE_HOST_KEY_CHECKING=False
      ansible-playbook deploy_play.yml \
        --ssh-common-args '-i ~/.ssh/zhdk_ci_executor_rsa' \
        -i ../zhdk-inventory/test-hosts
